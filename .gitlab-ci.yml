image: java:8-jdk

variables:
  DOCKER_DRIVER: overlay
  REGISTRY: registry.gitlab.com/maly7/kryption-api
  AUTH_KEY_LOC: authentication-service/src/main/resources/keys

stages:
- build_auth
- build_chat
- build_registry
- build_gateway
- test
- publish

before_script:
- export GRADLE_USER_HOME=`pwd`/.gradle

cache:
  paths:
  - .gradle/wrapper
  - chat-service/build
  - authentication-service/build
  - service-registry/build

build:
  stage: build_auth
  script:
  - openssl genrsa -out $AUTH_KEY_LOC/private_key.pem 2048
  - openssl pkcs8 -topk8 -inform PEM -outform DER -in $AUTH_KEY_LOC/private_key.pem -out $AUTH_KEY_LOC/private_key.der -nocrypt
  - openssl rsa -in $AUTH_KEY_LOC/private_key.pem -pubout -outform DER -out $AUTH_KEY_LOC/public_key.der
  - ./gradlew :authentication-service:assemble
  - ./gradlew versionFile
  artifacts:
    paths:
    - authentication-service/build
    untracked: true

build_chat:
  stage: build_chat
  script:
  - ./gradlew :chat-service:assemble
  - ./gradlew versionFile
  artifacts:
    paths:
    - chat-service/build
    untracked: true

build_registry:
  stage: build_registry
  script:
  - ./gradlew :service-registry:assemble
  - ./gradlew versionFile
  artifacts:
    paths:
    - service-registry/build
    untracked: true

build_gateway:
  stage: build_gateway
  script:
  - ./gradlew :api-gateway:assemble
  - ./gradlew versionFile
  artifacts:
    paths:
    - api-gateway/build
    untracked: true

test:
  stage: test
  services:
  - name: rabbitmq:3-management
    alias: rabbit
  script:
  - ./gradlew check -x :functional-tests:check -Dspring.rabbitmq.host=rabbit
  artifacts:
    when: always
    paths:
    - chat-service/build/reports
    - authentication-service/build/reports

publish:
  stage: publish
  image: docker:latest
  services:
  - docker:dind
  script:
  - source version.txt
  - docker login -u $CI_REGISTRY_USER -p $CI_JOB_TOKEN $REGISTRY
  - docker login -u $ACR_USER -p $ACR_PASS $ACR_REGISTRY
  - docker build chat-service -f chat-service/Dockerfile -t $REGISTRY/chat-service:latest -t $ACR_REGISTRY/chat-service:latest -t $REGISTRY/chat-service:$APP_VERSION -t $ACR_REGISTRY/chat-service:$APP_VERSION
  - docker build authentication-service -f authentication-service/Dockerfile -t $REGISTRY/authentication-service:latest -t $ACR_REGISTRY/authentication-service:latest -t $REGISTRY/authentication-service:$APP_VERSION -t $ACR_REGISTRY/authentication-service:$APP_VERSION
  - docker build service-registry -f service-registry/Dockerfile -t $REGISTRY/service-registry:latest -t $ACR_REGISTRY/service-registry:latest -t $REGISTRY/service-registry:$APP_VERSION -t $ACR_REGISTRY/service-registry:$APP_VERSION
  - docker build api-gateway -f api-gateway/Dockerfile -t $REGISTRY/api-gateway:latest -t $ACR_REGISTRY/api-gateway:latest -t $REGISTRY/api-gateway:$APP_VERSION -t $ACR_REGISTRY/api-gateway:$APP_VERSION
  - docker push $REGISTRY/chat-service
  - docker push $REGISTRY/authentication-service
  - docker push $REGISTRY/service-registry
  - docker push $REGISTRY/api-gateway
  - docker push $ACR_REGISTRY/chat-service
  - docker push $ACR_REGISTRY/authentication-service
  - docker push $ACR_REGISTRY/service-registry
  - docker push $ACR_REGISTRY/api-gateway
  only:
  - master
