image: java:8-jdk

variables:
  DOCKER_DRIVER: overlay
  REGISTRY: registry.gitlab.com/maly7/kryption-api
  AUTH_KEY_LOC: authentication-service/src/main/resources/keys

stages:
  - build
  - test
  - publish

before_script:
  - export GRADLE_USER_HOME=`pwd`/.gradle

cache:
  paths:
    - .gradle/wrapper
    - chat-service/build
    - authentication-service/build
    - service-registry/build

build:
  stage: build
  script:
    - openssl genrsa -out $AUTH_KEY_LOC/private_key.pem 2048
    - openssl pkcs8 -topk8 -inform PEM -outform DER -in $AUTH_KEY_LOC/private_key.pem -out $AUTH_KEY_LOC/private_key.der -nocrypt
    - openssl rsa -in $AUTH_KEY_LOC/private_key.pem -pubout -outform DER -out $AUTH_KEY_LOC/public_key.der
    - ./gradlew assemble -x :functional-tests:assemble
  artifacts:
    paths:
      - chat-service/build
      - authentication-service/build
      - service-registry/build
      - api-gateway/build
    untracked: true

test:
  stage: test
  services:
    - name: rabbitmq:3-management
      alias: rabbit
  script:
    - ./gradlew check -x :functional-tests:check -Dspring.rabbitmq.host=rabbit
  artifacts:
    when: always
    paths:
      - chat-service/build/reports
      - authentication-service/build/reports

publish:
  stage: publish
  image: docker:latest
  services:
    - docker:dind
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_JOB_TOKEN $REGISTRY
    - docker login -u $ACR_USER -p $ACR_PASS $ACR_REGISTRY
    - docker build chat-service:latest chat-service/
    - docker build authentication-service:latest authentication-service/
    - docker build service-registry:latest service-registry/
    - docker build api-gateway:latest api-gateway/
    - docker build rabbitmq:3-web-stomp rabbitmq/
    - docker tag chat-service:latest $REGISTRY/chat-service:latest
    - docker tag chat-service:latest $ACR_REGISTRY/chat-service:latest
    - docker tag authentication-service:latest $REGISTRY/authentication-service:latest
    - docker tag authentication-service:latest $ACR_REGISTRY/authentication-service:latest
    - docker tag service-registry:latest $REGISTRY/service-registry:latest
    - docker tag service-registry:latest $ACR_REGISTRY/service-registry:latest
    - docker tag api-gateway:latest $REGISTRY/api-gateway:latest
    - docker tag api-gateway:latest $ACR_REGISTRY/api-gateway:latest
    - docker tag rabbitmq:3-web-stomp $REGISTRY/rabbitmq:3-web-stomp
    - docker tag rabbitmq:3-web-stomp $ACR_REGISTRY/rabbitmq:3-web-stomp
    - docker push $REGISTRY/chat-service
    - docker push $REGISTRY/authentication-service
    - docker push $REGISTRY/service-registry
    - docker push $REGISTRY/api-gateway
    - docker push $REGISTRY/rabbitmq
    - docker push $ACR_REGISTRY/chat-service
    - docker push $ACR_REGISTRY/authentication-service
    - docker push $ACR_REGISTRY/service-registry
    - docker push $ACR_REGISTRY/api-gateway
    - docker push $ACR_REGISTRY/rabbitmq
  only:
    - master
