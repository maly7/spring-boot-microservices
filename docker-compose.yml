version: '3'

services:
  mysql:
    image: mysql:5.7
    container_name: mysql
    environment:
      MYSQL_USER: "${MYSQL_USER}"
      MYSQL_PASSWORD: "${MYSQL_PASSWORD}"
      MYSQL_ROOT_PASSWORD: "${MYSQL_ROOT_PASSWORD}"
      MYSQL_DATABASE: kryption
    ports:
      - "3306:3306"
    expose:
      - "3306"
    networks:
      - main
    volumes:
      - "mysql-data:/var/lib/mysql"
      - "mysql-logs:/var/log/mysql"
  mongodb:
    image: mongo:3.6.3
    container_name: mongodb
    environment:
      MONGO_INITDB_ROOT_USERNAME: "${MONGODB_USER}"
      MONGO_INITDB_ROOT_PASSWORD: "${MONGODB_PASSWORD}"
    ports:
      - "27017:27017"
    expose:
      - "27017"
    networks:
      - main
    volumes:
      - "mongodb-data:/data/db"
  rabbit:
    container_name: rabbit
    build: ./rabbitmq/
    hostname: "rabbit1"
    environment:
      RABBITMQ_ERLANG_COOKIE: "${RABBITMQ_ERLANG_COOKIE}"
      RABBITMQ_DEFAULT_USER: "${RABBITMQ_USER}"
      RABBITMQ_DEFAULT_PASS: "${RABBITMQ_PASS}"
      RABBITMQ_DEFAULT_VHOST: "/"
    ports:
      - "15672:15672"
      - "15674:15674"
      - "5672:5672"
    expose:
      - "15672"
      - "15674"
      - "5672"
    networks:
      - main
  service-registry:
    build: ./service-registry/
    container_name: service-registry
    ports:
      - "8761:8761"
    expose:
      - "8761"
    networks:
      - main
    volumes:
      - ./logs:/data/logs
  authentication-service:
    build: ./authentication-service/
    container_name: authentication-service
    ports:
      - "8180:8180"
    expose:
      - "8180"
    depends_on:
      - mysql
      - service-registry
    environment:
      MYSQL_USER: "${MYSQL_USER}"
      MYSQL_PASSWORD: "${MYSQL_PASSWORD}"
      RELATIONAL_JDBC_URL: jdbc:mysql://mysql:3306/kryption?autoReconnect=true
      EUREKA_URL: http://service-registry:8761/eureka/
    networks:
      - main
    volumes:
      - ./logs:/data/logs
  chat-service:
    build: ./chat-service/
    container_name: chat-service
    ports:
      - "8280:8280"
    depends_on:
      - mongodb
      - rabbit
      - service-registry
    environment:
      MONGODB_USER: "${MONGODB_USER}"
      MONGODB_PASSWORD: "${MONGODB_PASSWORD}"
      MONGODB_HOST: mongodb
      MONGODB_URL: mongodb://mongodb/kryption
      RABBITMQ_USER: "${RABBITMQ_USER}"
      RABBITMQ_PASS: "${RABBITMQ_PASS}"
      RABBITMQ_HOST: rabbit
      EUREKA_URL: http://service-registry:8761/eureka/
    networks:
      - main
    volumes:
      - ./logs:/data/logs
  api-gateway:
    build: ./api-gateway/
    container_name: api-gateway
    ports:
      - "8080:8080"
    depends_on:
      - service-registry
      - authentication-service
      - chat-service
    environment:
      EUREKA_URL: http://service-registry:8761/eureka/
    networks:
      - main
    volumes:
      - ./logs:/data/logs
networks:
  main:
volumes:
  mysql-data:
  mysql-logs:
  mongodb-data:
